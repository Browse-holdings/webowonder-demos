<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
	<head>
		<title>CubicVR 3D Engine - Javascript Port</title>
		<script src="CubicVR.js" type="text/javascript"></script>
		<script language="javascript" src="beatdetektor.js"></script>    
		<script language="javascript" src="fft.js"></script>    
		<script id="core-shader-vs" srcUrl="CubicVR_Core.vs" type="x-shader/x-vertex"></script>
		<script id="core-shader-fs" srcUrl="CubicVR_Core.fs" type="x-shader/x-fragment"></script>
    <script language="javascript">
			var bd;
			var kick_det;
			var vu;
			var m_BeatTimer = 0;
			var m_BeatCounter = 0;
			var clearClr = [0,0,1];
			var ftimer = 0;


      var bufferSize = 0;
      var signal = new Float32Array(bufferSize);
			var channels = 0;   
			var rate = 0;   
      var frameBufferLength = 0;
			var fft = null;

 	    function loadedMetadata() 
			{
					var audio = document.getElementById('audio1');

            channels      = audio.mozChannels;
            rate              = audio.mozSampleRate;
            frameBufferLength = audio.mozFrameBufferLength;

						bufferSize = frameBufferLength/channels;

        		fft = new FFT(bufferSize, rate);
	          signal = new Float32Array(bufferSize);
	
						audio.addEventListener("MozAudioAvailable",audioWritten,false);				
      }

      function audioWritten(event) 
			{
				if (fft == null) return;

        var fb = event.frameBuffer;

        for (var i = 0, fbl = bufferSize; i < fbl; i++ ) {
          // Assuming interlaced stereo channels,
          // need to split and merge into a stero-mix mono signal
          signal[i] = (fb[2*i] + fb[2*i+1]) / 2;
        }

        fft.forward(signal);

				//				timestamp = document.getElementById('audio1').currentTime;
				timestamp = event.time;

			  bd.process( timestamp, fft.spectrum );
        // Bass Kick detection
        kick_det.process(bd);
				
				if (bd.win_bpm_int_lo)
				{
					m_BeatTimer += bd.last_update;
					
					if (m_BeatTimer > (60.0/bd.win_bpm_int_lo)) 
					{
						m_BeatTimer -= (60.0/bd.win_bpm_int_lo);
						clearClr[0] = 0.5+Math.random()/2;
						clearClr[1] = 0.5+Math.random()/2;
						clearClr[2] = 0.5+Math.random()/2;
						m_BeatCounter++;
					}
				}
				
				ftimer += bd.last_update;
				if (ftimer > 1.0/30.0) 
				{
					vu.process(bd,1.0/30.0);
//					drawScene();
					ftimer = 0;
				}
				
      }


			
			var gl;
		  function initGL(canvas) {
		    try {
		      gl = canvas.getContext("experimental-webgl");
		
					canvas_w = window.innerWidth;
					canvas_h = window.innerHeight;

		      gl.viewport(0, 0, canvas_w, canvas_h);
					aspect = canvas_w/canvas_h;
		    } catch(e) {
		    }
		    if (!gl) {
		      alert("Could not initialise WebGL, sorry :-(");
		    }
		
				CubicVR.core.init(gl,"core-shader-vs","core-shader-fs");
	      bd = new BeatDetektor();
	      kick_det = new BeatDetektor.modules.vis.BassKick();    
				vu = new BeatDetektor.modules.vis.VU();
		  }
		
			var shaderProgram = null;
			var texSet = new Array()
			var maxSeg = 0;
			var toothAngle = 36;

			var gear_object;
			var box_object;
			
			var box_t = new Array();
			var light_test;


			function buildObject()
			{
				gear_object = new CubicVR.object();
				box_object = new CubicVR.object();

				// Make a material named test
				objMaterial = new CubicVR.material("test_material");
				var objMaterial2 = new CubicVR.material("test_material2");

				// Simple torus using lathe
				var pointList = new Array();
				var radius = 0.5;
				var thick = 0.3;
				var lat = 28.0;
				var light_test;


				pointList = [[0,-0.1,0],[-0.5,-0.1,0],[-0.5,0.1,0],[0,0.1,0]];
				CubicVR.genLatheObject(gear_object,pointList,64,objMaterial,CubicVR.newTransform().translate(0.0,0.0,0.0));				
				for (var i = 0; i < 360; i += toothAngle)
				{
					CubicVR.genBoxObject(gear_object,0.15,objMaterial,CubicVR.newTransform().translate(0.5,0,0.0).pushMatrix().rotate([0,i,0]));									
				}

				gear_object.calcNormals();

				CubicVR.genBoxObject(box_object,1,objMaterial2,CubicVR.newTransform().translate(0.0,0.5,0.0));									
				
				box_object.calcNormals();
				

				texSet.push([new CubicVR.texture("images/2576-diffuse.jpg"),new CubicVR.texture("images/2576-bump.jpg"),new CubicVR.texture("images/2576-normal.jpg")]);
				texSet.push([new CubicVR.texture("images/1422-diffuse.jpg"),new CubicVR.texture("images/1422-bump.jpg"),new CubicVR.texture("images/1422-normal.jpg")]);

//				var envMap = new CubicVR.texture("images/sky.png");				
				
				objMaterial.setTexture(texSet[0][0],TEXTURE_MAP_COLOR);
//				objMaterial.setTexture(texSet[0][1],TEXTURE_MAP_BUMP);
				objMaterial.setTexture(texSet[0][2],TEXTURE_MAP_NORMAL);
//				objMaterial.setTexture(envMap,TEXTURE_MAP_ENVSPHERE);

				objMaterial2.setTexture(texSet[1][0],TEXTURE_MAP_COLOR);
//				objMaterial2.setTexture(texSet[1][1],TEXTURE_MAP_BUMP);
				objMaterial2.setTexture(texSet[1][2],TEXTURE_MAP_NORMAL);
//				objMaterial2.setTexture(envMap,TEXTURE_MAP_ENVSPHERE);

				// Create a UV Mapper and apply it to objMaterial
				objMaterialMap = new CubicVR.uvmapper();
				objMaterialMap.projection_mode = UV_PROJECTION_CUBIC;
				objMaterialMap.projection_axis = UV_AXIS_Y;
				objMaterialMap.wrap_w_count = 5.0;
				objMaterialMap.scale = [3,3,3];
				objMaterialMap.apply(gear_object,objMaterial);
				objMaterialMap.apply(box_object,objMaterial2);

				gear_object.triangulateQuads();
				gear_object.compile();			

				box_object.triangulateQuads();
				box_object.compile();			
				
			}

			function webGLStart() 
			{
		    var canvas = document.getElementById("cubicvr-canvas");
		    initGL(canvas);				
				
				buildObject();

				light_test = new cubicvr_light(LIGHT_TYPE_POINT);
				light_test.position = [0,5,0];
				light_test.distance = 20.0;
				light_test.intensity = 5.0;

		    gl.clearColor(0.0, 0.0, 0.0, 1.0);

		    gl.clearDepth(1.0);

		    gl.enable(gl.DEPTH_TEST);
		    gl.depthFunc(gl.LEQUAL);

		    setInterval(drawScene, 30);
		  }
		  
		
		 	var xp = 0;
			var cp = 0;
			var activeTex = 0;
			var lastTex = -1;
		
			var camPos = [2,2,-2];
			var camTarget = [0,1,0];
			var camDist = 2.0;
			var firstRun = true;
		
			var timerMilliseconds;
			var timerSeconds = 0;
			var timerLastSeconds = 0;
			var frameCounter = 0;
			
		  function drawScene() 
			{
				if (!bd.last_timer) return;
				if (!timerMilliseconds)
				{
				 	timerMilliseconds = (new Date()).getTime();
					return;
				}
			
				frameCounter++;
				
				var newTimerMilliseconds = (new Date()).getTime();
				
				timerLastSeconds = (newTimerMilliseconds-timerMilliseconds)/1000.0;

				if (timerLastSeconds > (1/10)) timerLastSeconds = (1/10);

				timerSeconds += timerLastSeconds;
				timerMilliseconds = newTimerMilliseconds;

				if (timerSeconds > 10 && timerSeconds < 15) document.getElementById('musicTitle').style.opacity = (5-(timerSeconds-10))/5.0;
				if (timerSeconds > 15 && timerSeconds < 16) document.getElementById('musicTitle').style.opacity = 0;


				var kickNorm = (m_BeatTimer / (60.0/bd.win_bpm_int_lo));

				xp += kickNorm*toothAngle*0.05;
				cp += 1.0;
				
				
		    if (bd.win_bpm_int_lo) gl.clearColor(clearClr[0]*(1.0-kickNorm),clearClr[1]*(1.0-kickNorm),clearClr[2]*(1.0-kickNorm), 1.0);
				
				light_test.diffuse = [clearClr[0]*(1.0-kickNorm*0.8),clearClr[1]*(1.0-kickNorm*0.8),clearClr[2]*(1.0-kickNorm*0.8)];

				light_test.position = [3*Math.sin(3.0*cp*(M_PI/180.0)),10,3*Math.cos(4.0*cp*(M_PI/180.0))];


		    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

				modelViewMat = CubicVR.lookat(1+Math.sin(cp*0.4*(M_PI/180.0))*10*Math.sin((cp)*(M_PI/180.0)),3+(2+Math.cos((cp)*(M_PI/180.0))),1+Math.sin(cp*0.4*(M_PI/180.0))*10*Math.cos((cp)*(M_PI/180.0)),camTarget[0], camTarget[1], camTarget[2], 0, 1, 0);

				projectionMat = CubicVR.perspective(90 + 20*Math.sin(cp/1000.0), 1.0, 0.1, 100.0); 					

				// for (i = -5; i < 5; i++)
				// CubicVR.renderObject(gear_object,modelViewMat,projectionMat,
				// 	CubicVR.newTransform().rotate([0,(xp+(toothAngle/4)*m_BeatCounter)*((Math.abs(i)%2==0)?-1:1)+((Math.abs(i)%2==0)?(toothAngle/2):0),0]).pushMatrix().translate(i*1.14,0,0).pushMatrix().rotate([xp+i*5+i*2*kickNorm,0,0]).getResult());
				// 
				// for (i = -5; i < 5; i++) if (i != 0)
				// CubicVR.renderObject(gear_object,modelViewMat,projectionMat,
				// 	CubicVR.newTransform().rotate([0,(xp+(toothAngle/4)*m_BeatCounter)*((Math.abs(i)%2==0)?-1:1)+((Math.abs(i)%2==0)?(toothAngle/2):0),0]).pushMatrix().translate(0,0,i*1.14).pushMatrix().rotate([xp,0,i*5+i*2*kickNorm]).getResult());

				var c = 0;
				var t;
				for (var i = -5; i < 5; i++)
				{
					for (var j = -5; j < 5; j++)
					{
						if (firstRun) 
						{
							box_t[c] = CubicVR.newTransform().translate(i+0.5,0,j+0.5).pushMatrix().getResult();
						}
						
						var l = 1.0+(vu.vu_levels[c])*3.0;
						
						box_t[c][5] = l;
						
						CubicVR.renderObject(box_object,modelViewMat,projectionMat,box_t[c],[light_test]);	
							
						c++;
					}
				}
				firstRun = false;

		  }			


			var windowTimer = null;

			window.onresize = function()
			{
					if (windowTimer == null)
					{
						windowTimer = setTimeout(doWindowResize,1000);
					}
					else
					{
						clearTimeout(windowTimer);
						windowTimer = setTimeout(doWindowResize,1000);
					}
			}


			function doWindowResize()
			{
				if (!gl) return;

				var canvas = document.getElementById("cubicvr-canvas");

				canvas_w = window.innerWidth;
	       canvas_h = window.innerHeight;
	       aspect = canvas_w / canvas_h;

				canvas.width=canvas_w;
				canvas.height=canvas_h;

	//			scene.camera.setDimensions(canvas_w,canvas_h);

				gl.viewport(0, 0, canvas_w, canvas_h);

				document.getElementById('musicTitle').style.top=(window.innerHeight-120)+"px";
			}

		</script>
	</head>
		<body onLoad="webGLStart();" style='margin:0px;overflow:hidden;background:black'>
			<script type='text/javascript'>
				canvas_w = window.innerWidth;
				canvas_h = window.innerHeight;
				aspect = canvas_w/canvas_h;

				document.write("<canvas id='cubicvr-canvas' style='border: none;' width='"+window.innerWidth+"' height='"+(window.innerHeight)+"'>");
				</script></canvas><audio id='audio1' tabindex="0" src="Charles_J_Cliffe-Graviton_Emissions.ogg" controls="true" 
	onmozaudioavailable="audioWritten(event);" onloadedmetadata="loadedMetadata();" style="width: 512px; position:absolute; top:0px; left:0px"></audio>
	<script type='text/javascript'>
		document.write("<div id='musicTitle' style='position:absolute;top:"+(window.innerHeight-120)+"px;left:0px;width:300px;height:120px;color:white;font-family:Arial;font-size:20px;padding:10px'>");
		</script>
		<u>Track: Graviton Emissions</u><br>
		Music &amp; Code by Charles J. Cliffe<br>
		<a style='text-decoration:none; color:blue' href="http://www.cubicvr.org/">http://www.cubicvr.org/</a>
		</div></body></html>

